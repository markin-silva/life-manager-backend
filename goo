#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]}"
if command -v readlink >/dev/null 2>&1; then
  SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH" 2>/dev/null || echo "$SCRIPT_PATH")"
fi
PROJECT_ROOT="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
cd "$PROJECT_ROOT"

SERVICE_NAME="${SERVICE_NAME:-api}"

say() {
  printf '%s\n' "$*"
}

die() {
  printf 'Error: %s\n' "$*" >&2
  exit 1
}

require_root() {
  if [[ ! -f "$PROJECT_ROOT/docker-compose.yml" && ! -f "$PROJECT_ROOT/docker-compose.yaml" ]]; then
    die "Run goo from the project root (docker-compose.yml not found)."
  fi
}

require_docker() {
  command -v docker >/dev/null 2>&1 || die "Docker not found in PATH."
  docker compose version >/dev/null 2>&1 || die "Docker Compose is not available (docker compose)."
}

require_service_running() {
  local running
  running="$(docker compose ps --status running --services 2>/dev/null | grep -Fx "$SERVICE_NAME" || true)"
  if [[ -z "$running" ]]; then
    die "Service '$SERVICE_NAME' is not running. Run: goo up"
  fi
}

usage() {
  cat <<'EOF'
Usage: goo <command>

Commmands:
  setup              install goo in PATH (/usr/local/bin)
  build              docker compose build
  up                 docker compose up
  down               docker compose down
  restart            down + up
  bundle             docker compose run --rm api bundle install
  rails c            docker compose run --rm api rails console
  rails s            docker compose exec api rails server -b 0.0.0.0
  db migrate         docker compose run --rm api rails db:migrate
  db rollback        docker compose run --rm api rails db:rollback
  db seed            docker compose run --rm api rails db:seed
  test               run tests (RSpec)
  cop                run Rubocop
  help               show this help

Variables:
  SERVICE_NAME       docker compose service name (default: api)
EOF
}

do_setup() {
  local target="/usr/local/bin/goo"
  if ln -sf "$PROJECT_ROOT/goo" "$target" 2>/dev/null; then
    say "→ Installed at $target"
    return 0
  fi

  if [[ -w "${target%/*}" ]]; then
    die "Failed to create symlink at $target."
  fi

  die "No permission to write to ${target%/*}. Try: sudo goo setup"
}

main() {
  require_root

  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  case "$1" in
    setup)
      do_setup
      ;;
    build)
      require_docker
      say "→ Building images..."
      docker compose build
      ;;
    up)
      require_docker
      say "→ Starting containers..."
      docker compose up
      ;;
    down)
      require_docker
      say "→ Stopping containers..."
      docker compose down
      ;;
    restart)
      require_docker
      say "→ Restarting containers..."
      docker compose down
      docker compose up
      ;;
    bundle)
      require_docker
      say "→ Installing gems..."
      docker compose run --rm "$SERVICE_NAME" bundle install
      ;;
    rails)
      require_docker
      case "${2:-}" in
        c)
          say "→ Opening Rails console..."
          docker compose run --rm "$SERVICE_NAME" rails console
          ;;
        s)
          require_service_running
          say "→ Starting Rails server..."
          docker compose exec "$SERVICE_NAME" rails server -b 0.0.0.0
          ;;
        *)
          die "Use: goo rails c | goo rails s"
          ;;
      esac
      ;;
    db)
      require_docker
      case "${2:-}" in
        migrate)
          say "→ Running migrations..."
          docker compose run --rm "$SERVICE_NAME" rails db:migrate
          ;;
        rollback)
          say "→ Rolling back migrations..."
          docker compose run --rm "$SERVICE_NAME" rails db:rollback
          ;;
        seed)
          say "→ Seeding database..."
          docker compose run --rm "$SERVICE_NAME" rails db:seed
          ;;
        *)
          die "Use: goo db migrate | goo db rollback | goo db seed"
          ;;
      esac
      ;;
    test)
      require_docker
      say "→ Preparing test environment..."
      docker compose run --rm -e RAILS_ENV=test "$SERVICE_NAME" rails db:prepare
      say "→ Running tests (RSpec)..."
      docker compose run --rm -e RAILS_ENV=test "$SERVICE_NAME" bundle exec rspec
      ;;
    cop)
      require_docker
      say "→ Running Rubocop..."
      docker compose run --rm "$SERVICE_NAME" bundle exec rubocop
      ;;
    help|-h|--help)
      usage
      ;;
    *)
      die "Invalid command: $1 (use 'goo help')"
      ;;
  esac
}

main "$@"
